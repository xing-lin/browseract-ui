name: Release on main (test -> publish -> deploy storybook)

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write
  packages: write
  id-token: write
  pull-requests: write

env:
  TARGET_REPO: 'xing-lin/xing-lin.github.io'

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (full history & tags)
        uses: actions/checkout@v4

      # âš ï¸ é‡è¦ï¼šä½¿ç”¨ Trusted Publisher æ—¶ï¼Œä¸è¦é…ç½® registry-url
      # registry-url ä¼šåˆ›å»ºéœ€è¦ NODE_AUTH_TOKEN çš„ .npmrcï¼Œä¸Ž OIDC å†²çª
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Configure npm for Trusted Publishing
        run: |
          # æ¸…ç†å¯èƒ½å­˜åœ¨çš„æ—§ .npmrc é…ç½®
          rm -f ~/.npmrc .npmrc || true

          # ç¡®ä¿ npm ç‰ˆæœ¬æ”¯æŒ Trusted Publishingï¼ˆéœ€è¦ npm >= 9.5.0ï¼‰
          echo "npm version: $(npm --version)"

          # åˆ›å»º .npmrc é…ç½®
          # ä½¿ç”¨ Trusted Publishing (OIDC)ï¼Œä¸éœ€è¦é¢„å…ˆè®¾ç½® authToken
          cat > ~/.npmrc <<-EOF
            registry=https://registry.npmjs.org/
            provenance=true
          EOF

          # æ˜¾ç¤ºé…ç½®ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo "Created ~/.npmrc:"
          cat ~/.npmrc

          echo ""
          echo "OIDC çŽ¯å¢ƒå˜é‡æ£€æŸ¥:"
          echo "ACTIONS_ID_TOKEN_REQUEST_URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:-âŒ NOT SET}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+âœ… SET}"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Run tests with coverage
        run: |
          npm run test:coverage

      - name: Show coverage files (debug)
        run: |
          echo "Coverage folder listing (for debug):"
          ls -la coverage || true
          find coverage -maxdepth 4 -type f -print || true
          if [ -f coverage/lcov.info ]; then
            echo "lcov found: coverage/lcov.info"
            echo "---- head of lcov.info ----"
            head -n 20 coverage/lcov.info || true
            echo "---- end head ----"
          else
            echo "WARNING: coverage/lcov.info not found. Ensure vitest is configured with reporters including 'lcov'."
            exit 1
          fi

      - name: Upload coverage to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: coverage/lcov.info

      - name: Build package (rollup)
        run: npm run build

      - name: Run semantic-release (determine version, tag, update package.json, publish to npm)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # å®Œå…¨ä½¿ç”¨ Trusted Publishing (OIDC)ï¼Œæ— éœ€ NPM_TOKEN
          NPM_CONFIG_PROVENANCE: true
        run: |
          # éªŒè¯ OIDC token çŽ¯å¢ƒå˜é‡
          echo "=== OIDC Token çŽ¯å¢ƒæ£€æŸ¥ ==="
          echo "ACTIONS_ID_TOKEN_REQUEST_URL: ${ACTIONS_ID_TOKEN_REQUEST_URL:-âŒ NOT SET}"
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN: ${ACTIONS_ID_TOKEN_REQUEST_TOKEN:+âœ… SET}"

          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ]; then
            echo "âŒ é”™è¯¯ï¼šOIDC token çŽ¯å¢ƒå˜é‡æœªè®¾ç½®"
            echo "è¯·ç¡®ä¿åœ¨ GitHub ä»“åº“ä¸­é…ç½®äº† npm çš„ Trusted Publishing"
            exit 1
          fi

          # éªŒè¯ npm é…ç½®
          echo -e "\n=== npm é…ç½®æ£€æŸ¥ ==="
          echo "npm version: $(npm --version)"
          npm config list

          # è¿è¡Œ semantic-release
          # npm CLI ä¼šè‡ªåŠ¨ä½¿ç”¨ OIDC (Trusted Publishing) è¿›è¡Œè®¤è¯å’Œå‘å¸ƒ
          # æ— éœ€ NPM_TOKENï¼Œå®Œå…¨ä¾èµ– GitHub Actions OIDC
          echo -e "\n=== è¿è¡Œ semantic-release (ä½¿ç”¨ Trusted Publishing) ==="
          npx semantic-release

      - name: Fetch latest main (get semantic-release's commits / updated package.json & tags)
        run: |
          git fetch origin main --tags
          git checkout main
          git reset --hard origin/main
          git --no-pager log -n 5 --pretty=oneline

      - name: Show package version (debug)
        run: |
          echo "package.json version:"
          node -p "require('./package.json').version"
      - name: Show package version (debug)
        run: |
          echo "package.json version:"
          node -p "require('./package.json').version"

      - name: Build Storybook static
        run: npm run build-storybook

      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          path: target_repo
          fetch-depth: 0

      - name: Deploy storybook to target repo (checkout approach)
        env:
          TARGET_REPO: ${{ env.TARGET_REPO }}
          TARGET_DIR: target_repo
        run: |
          set -euo pipefail

          SRC_DIR="${GITHUB_WORKSPACE}/storybook-static"
          if [ ! -d "$SRC_DIR" ]; then
            echo "ERROR: storybook build output not found at ${SRC_DIR}"
            exit 1
          fi

          PACKAGE_VERSION=$(node -p "require('${GITHUB_WORKSPACE}/package.json').version")
          echo "Deploying storybook v${PACKAGE_VERSION} to ${TARGET_REPO}:main (path: static/storybook-static)"

          cd "${TARGET_DIR}"

          if git ls-remote --exit-code origin refs/heads/main >/dev/null 2>&1; then
            git fetch origin main
            git checkout main
            git reset --hard origin/main
          else
            git checkout --orphan main
            git rm -rf .
            git commit --allow-empty -m "chore: initialize main branch"
            git push origin main || true
          fi

          TARGET_PATH="static/storybook-static"
          echo "Removing old ${TARGET_PATH} (if exists)"
          rm -rf "${TARGET_PATH}" || true
          mkdir -p "$(dirname "${TARGET_PATH}")"

          echo "Copying new storybook static files..."
          cp -R "${SRC_DIR}/." "${TARGET_PATH}/"

          git config user.name "github-actions[bot]" || true
          git config user.email "github-actions[bot]@users.noreply.github.com" || true

          git add -A
          if git diff --cached --quiet; then
            echo "No changes to deploy (storybook content identical)."
          else
            git commit -m "chore(storybook): deploy storybook v${PACKAGE_VERSION} from $GITHUB_REPOSITORY@${GITHUB_SHA}"
            git push origin main
            echo "Pushed storybook to ${TARGET_REPO}:main"
          fi

      - name: Notify Feishu (publish)
        # ä¸è®ºæˆåŠŸå¤±è´¥éƒ½ä¸å½±å“åŽç»­æ­¥éª¤
        continue-on-error: true
        env:
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
          FEISHU_SECRET: ${{ secrets.FEISHU_SECRET }}
          PACKAGE_VERSION: ${{ steps.show_package_version.outputs.version || '' }}
        run: |
          set -euo pipefail

          # --- èŽ·å–ç‰ˆæœ¬ï¼ˆå¦‚æžœä¸Šä¸€æ­¥æ²¡æœ‰è¾“å‡ºï¼Œä¹Ÿä»Ž package.json è¯»ï¼‰ ---
          if [ -z "${PACKAGE_VERSION:-}" ]; then
            PACKAGE_VERSION=$(node -p "require('./package.json').version")
          fi

          # è§„èŒƒåŒ– tag åï¼ˆå¦‚æžœ version å·²ä»¥ v å¼€å¤´å°±ç›´æŽ¥ç”¨ï¼Œå¦åˆ™åŠ  v å‰ç¼€ï¼‰
          if [[ "${PACKAGE_VERSION}" == v* ]]; then
            TAG_NAME="${PACKAGE_VERSION}"
          else
            TAG_NAME="v${PACKAGE_VERSION}"
          fi

          # Release URL å¯ç›´æŽ¥æ‰“å¼€ changelog
          TAG_URL="https://github.com/${GITHUB_REPOSITORY}/releases/tag/${TAG_NAME}"

          # ä½¿ç”¨ç§’çº§ timestampï¼ˆè‹¥éœ€æ¯«ç§’å¯æ”¹ä¸º python3 å–æ¯«ç§’ï¼‰
          timestamp=$(date +%s)

          # æž„é€  string_to_signï¼ˆå¿…é¡»å«çœŸå®žæ¢è¡Œï¼‰
          string_to_sign=$(printf "%s\n%s" "$timestamp" "$FEISHU_SECRET")

          # ç”¨ string_to_sign ä½œä¸º HMAC keyï¼Œå¯¹ ç©ºæ¶ˆæ¯ åš HMAC-SHA256ï¼Œè¾“å‡ºäºŒè¿›åˆ¶å¹¶ base64
          sign=$(printf "" | openssl dgst -sha256 -hmac "$string_to_sign" -binary | base64)

          # URL-encode ç­¾åï¼ˆä¼˜å…ˆä½¿ç”¨ python3 çš„ urllib.parse.quoteï¼Œç¨³å¦¥ï¼‰
          if command -v python3 >/dev/null 2>&1; then
            sign_enc=$(python3 -c "import sys,urllib.parse; print(urllib.parse.quote(sys.stdin.read().strip(), safe=''))" <<<"$sign")
          else
            # å…œåº•çš„ç®€å• urlencodeï¼ˆåªé’ˆå¯¹ base64 ä¸­å¸¸è§å­—ç¬¦ï¼‰
            sign_enc=$(echo -n "$sign" | sed -e 's/+/%2B/g' -e 's/\//%2F/g' -e 's/=/%3D/g')
          fi

          NPM_PKG_NAME=$(node -p "require('./package.json').name")
          REPO_URL="https://github.com/${GITHUB_REPOSITORY}"
          DOCS_URL="https://xing-lin.github.io/components"

          # æž„é€ æ¶ˆæ¯ä½“ï¼ˆä½¿ç”¨ cat <<JSON ä¿è¯å˜é‡ä¼šè¢«å±•å¼€ä¸”ä¸äº§ç”Ÿå¤šä½™ç¼©è¿›ï¼‰
          json=$(cat <<JSON
          {"msg_type":"text","content":{"text":"ðŸš€ å‘å¸ƒæˆåŠŸ\nRepository: ${REPO_URL}\nVersion: ${PACKAGE_VERSION}\nRelease: ${TAG_URL}\nDocs: ${DOCS_URL}"}}
          JSON
          )

          # å‘é€è¯·æ±‚ï¼›å³ä½¿å¤±è´¥ä¹Ÿä¸è¦è®© step è¿”å›žéž 0
          FEISHU_URL="${FEISHU_WEBHOOK}?timestamp=${timestamp}&sign=${sign_enc}"
          echo "Sending notification to Feishu (non-blocking)..."
          resp=$(curl -s -X POST "${FEISHU_URL}" \
            -H "Content-Type: application/json" \
            -d "${json}" ) || true

          echo "Feishu response: $resp"

      - name: Done
        run: echo "Test -> Release -> Storybook deploy finished."
